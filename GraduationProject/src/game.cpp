//=============================================
//
//ゲーム[game.cpp]
//Author Matsuda Towa
//
//=============================================
#include "game.h"
#include "game_field.h"
#include "game_player.h"
#include "game_camera.h"
#include "game_manager.h"
#include "enemy.h"
#include "card.h"

namespace
{
	const D3DXVECTOR3 FIELD_SIZE = { 200.0f,0.0f,200.0f };
	const int COOL_TIME = 1;
	const int DELAY_FRAME = 90;
}

//=============================================
//コンストラクタ
//=============================================
My::CGame::CGame():
m_pPauseCnt(nullptr),				//ポーズのキーを有効化するためのカウント
m_pDelayCnt(nullptr)				//リザルトに遷移するまでのディレイカウント
{
	CGameManager::GetInstance()->SetFinish(false);
}

//=============================================
//デストラクタ
//=============================================
My::CGame::~CGame()
{
}

//=============================================
//初期化
//=============================================
HRESULT My::CGame::Init()
{
	for (int i = 0; i < CAMERA_MAX; ++i)
	{
		CREATE_CAMERA(new CGameCamera);
		switch (i)
		{
		case GAME_CAMERA:
			GET_CAMERA(i)->ChangeCameraState(new CBirdView);
			break;
		case EVENT_CAMERA_000:
			GET_CAMERA(i)->ChangeCameraState(new CBirdView);
			break;
		case EVENT_CAMERA_001:
			GET_CAMERA(i)->ChangeCameraState(new CBirdView);
			break;
		case BOARD_GENERATE_CAMERA:
			GET_CAMERA(i)->ChangeCameraState(new CBirdView);
			break;
		default:
			break;
		}
	}
	SET_CAMERA_IDX(GAME_CAMERA);

	CGameState* current_state = CGameManager::GetInstance()->GetState();
	if (current_state == nullptr)
	{
		current_state = new CNormal;
	}		
	CGameManager::GetInstance()->SetState(current_state);

	if (m_pPauseCnt == nullptr)
	{
		m_pPauseCnt = new CCount;
		m_pPauseCnt->SetFrame(COOL_TIME);
	}

	if (m_pDelayCnt == nullptr)
	{
		m_pDelayCnt = new CCount;
		m_pDelayCnt->SetFrame(DELAY_FRAME);
	}
	//地面生成
	CField::Create(VEC3_RESET_ZERO, FIELD_SIZE,new CGameField);

	//エリア生成
	CreateArea();

	//プレイヤー生成
	CPlayer::Create(new CGamePlayer);

	CEnemy::Create({ 300.0f,0.0f,00.0f }, { 0.0f,1.75f,0.f });
	CEnemy::Create({ -300.0f,0.0f,00.0f }, { 0.0f,-1.75f,0.f });
	CEnemy::Create({ 0.0f,0.0f,250.0f }, { 0.0f,0.0f,0.f });

	CCard::Create();

	return S_OK;
}

//=============================================
//エリアの生成
//=============================================
void My::CGame::CreateArea()
{
	for (int i = 0; i < CInputMouse::AREA::MAX - 1; ++i)
	{
		CArea* area = CGameManager::GetInstance()->GetArea(i);
		if (area != nullptr) { continue; }

		//三角形の頂点座標を指定
		D3DXVECTOR2 triangle_vtx[CObject2D_Triangle::NUM_VERTEX];

		//ウィンドウの中心にを必ず頂点に
		D3DXVECTOR2 center = { SCREEN_WIDTH * HALF,SCREEN_HEIGHT * HALF };
		triangle_vtx[1] = center;

		//それぞれの頂点位置を指定
		switch (i)
		{
		case CInputMouse::AREA::UP:
			triangle_vtx[0] = { SCREEN_WIDTH,FLOAT_ZERO };
			triangle_vtx[2] = { VEC2_RESET_ZERO };
			break;
		case CInputMouse::AREA::DOWN:
			triangle_vtx[0] = { FLOAT_ZERO,SCREEN_HEIGHT };
			triangle_vtx[2] = { SCREEN_WIDTH,SCREEN_HEIGHT };
			break;
		case CInputMouse::AREA::LEFT:
			triangle_vtx[0] = { FLOAT_ZERO,FLOAT_ZERO };
			triangle_vtx[2] = { FLOAT_ZERO,SCREEN_HEIGHT };
			break;
		case CInputMouse::AREA::RIGHT:
			triangle_vtx[0] = { SCREEN_WIDTH,SCREEN_HEIGHT };
			triangle_vtx[2] = { SCREEN_WIDTH,FLOAT_ZERO };
			break;
		default:
			break;
		}
		area = CArea::Create(triangle_vtx);

		CGameManager::GetInstance()->SetArea(area, i);
	}
}

//=============================================
//終了
//=============================================
void My::CGame::Uninit()
{
	////ジェイソンの情報削除
	//if (CJson::GetJson() != nullptr)
	//{
	//	delete CJson::GetJson();
	//	CJson::GetJson() = nullptr;
	//}

	if (m_pDelayCnt != nullptr)
	{
		delete m_pDelayCnt;
		m_pDelayCnt = nullptr;
	}

	if (m_pPauseCnt != nullptr)
	{
		delete m_pPauseCnt;
		m_pPauseCnt = nullptr;
	}

	//ステート初期化
	CGameManager::GetInstance()->ChangeState(new CNormal);

	//マネージャーで管理しているオブジェクトをここで削除
	//NOTE: オブジェクトのReleaseAll前に消すことで二重で削除することを防止
	CGameManager::GetInstance()->GetPlayer()->Uninit();
	CGameManager::GetInstance()->SetPlayer(nullptr);
	CGameManager::GetInstance()->GetField()->Uninit();
	CGameManager::GetInstance()->SetField(nullptr);
	CGameManager::GetInstance()->Uninit();

	CObject::ReleaseAll();
	CGameManager::GetInstance()->Uninit();
}

//=============================================
//更新
//=============================================
void My::CGame::Update()
{
	if (!CGameManager::GetInstance()->GetFinish())
	{
		//TODO:ゲームステートでカードを持っているときにこの関数を実行
		SelectArea();

		//ポーズのカウントアップ
		m_pPauseCnt->CountUp();

#ifdef _DEBUG
		//インプット取得
		CInputKeyboard* pKeyboard = GET_INPUT_KEYBOARD;
		CInputMouse* pMouse = GET_INPUT_MOUSE;

		if (pKeyboard->GetTrigger(DIK_RETURN))
		{
			GET_FADE->SetFade(CScene::MODE::MODE_RESULT);
		}
#endif // _DEBUG


		CGameManager::GetInstance()->GameStateExecution(this);
		return;
	}

	if (!m_pDelayCnt->CountUp())
	{
		return;
	}
	//ステート初期化
	CGameManager::GetInstance()->ChangeState(new CNormal);
	GET_FADE->SetFade(CScene::MODE::MODE_RESULT);
}

//=============================================
//エリアの選択
//=============================================
void My::CGame::SelectArea()
{
	CInputMouse::AREA area = GET_INPUT_MOUSE->GetArea();

	for (int i = 0; i < CInputMouse::AREA::MAX - 1; ++i)
	{
		CGameManager::GetInstance()->GetArea(i)->SetSelect(false);
		if (area == CInputMouse::CENTER) { continue; }

		//選択されているところは明るく
		CGameManager::GetInstance()->GetArea(area)->SetSelect(true);
	}
}

//=============================================
//オブジェクトの更新を行うか決定
//=============================================
void My::CGame::StopObject(bool isStop)
{
	//プライオリティの数だけ周回
	for (int i = 0; i < CObject::PRI_MAX; i++)
	{
		CObject* pObj = CObject::GetTopObject(i);	//先頭取得

		//最大数が不明なのでwhileを使用
		while (pObj != nullptr)
		{
			CObject* pNext = pObj->GetNext();	//次のポインタを取得

			if (pObj->GetStop() != isStop)
			{
				pObj->SetStop(isStop);
			}

			pObj = pNext;					//ポインタを進める
		}
	}
}

//=============================================
//描画
//=============================================
void My::CGame::Draw()
{
	GET_CAMERA(GET_CAMERA_IDX)->SetCamera();
	GET_CAMERA(BOARD_GENERATE_CAMERA)->SetCamera();
}
